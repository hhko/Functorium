//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by source generator
//
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#nullable enable

using Functorium.Abstractions;
using Functorium.Applications.Observabilities;
using Functorium.Applications.Observabilities.Context;
using Functorium.Applications.Observabilities.Metrics;
using Functorium.Applications.Observabilities.Spans;

using LanguageExt;
using Microsoft.Extensions.Logging;

using ObservabilityNaming = Functorium.Applications.Observabilities.ObservabilityNaming;

namespace TestNamespace;

public class DerivedAdapterPipeline : DerivedAdapter
{
    private readonly IObservabilityContext? _parentContext;

    private readonly ILogger<DerivedAdapterPipeline> _logger;
    private readonly ISpanFactory _spanFactory;
    private readonly IMetricRecorder _metricRecorder;

    private const string RequestHandler = nameof(DerivedAdapter);

    private readonly bool _isDebugEnabled;
    private readonly bool _isInformationEnabled;
    private readonly bool _isWarningEnabled;
    private readonly bool _isErrorEnabled;

    public DerivedAdapterPipeline(
        IObservabilityContext? parentContext,
        ILogger<DerivedAdapterPipeline> logger,
        ISpanFactory spanFactory,
        IMetricRecorder metricRecorder,
        string connectionString)
        : base(connectionString)
    {
        global::System.ArgumentNullException.ThrowIfNull(spanFactory);
        global::System.ArgumentNullException.ThrowIfNull(metricRecorder);

        _parentContext = parentContext;
        _logger = logger;
        _spanFactory = spanFactory;
        _metricRecorder = metricRecorder;

        _isDebugEnabled = logger.IsEnabled(LogLevel.Debug);
        _isInformationEnabled = logger.IsEnabled(LogLevel.Information);
        _isWarningEnabled = logger.IsEnabled(LogLevel.Warning);
        _isErrorEnabled = logger.IsEnabled(LogLevel.Error);
    }

    private static global::LanguageExt.IO<A> FinTToIO<A>(global::LanguageExt.FinT<global::LanguageExt.IO, A> finT) =>
        ((global::LanguageExt.IO<global::LanguageExt.IO<A>>)finT.Match(
            Succ: value => global::LanguageExt.IO.pure(value),
            Fail: global::LanguageExt.IO.fail<A>
        )).Flatten();

    private global::LanguageExt.IO<A> ExecuteWithSpan<A>(
            string requestHandler,
            string requestHandlerMethod,
            global::LanguageExt.IO<A> operation,
            global::System.Func<global::LanguageExt.IO<global::LanguageExt.Unit>> requestLog,
            global::System.Action<string, string, A, double> responseLogSuccess,
            global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
            long startTimestamp) =>
        AcquireSpan(requestHandler, requestHandlerMethod)
            .Bracket(
                Use: span =>
                    from _logged in requestLog()
                    from result in ExecuteOperationWithErrorHandling(
                        requestHandler,
                        requestHandlerMethod,
                        operation,
                        span,
                        responseLogSuccess,
                        responseLogFailure,
                        startTimestamp)
                    select result,
                Fin: span => global::LanguageExt.IO.lift(() =>
                {
                    span?.Dispose();
                    return global::LanguageExt.Unit.Default;
                }));

    private global::LanguageExt.IO<A> ExecuteOperationWithErrorHandling<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.IO<A> operation,
        ISpan? span,
        global::System.Action<string, string, A, double> responseLogSuccess,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
        long startTimestamp) =>
        operation
            .Bind(result =>
                from _ in global::LanguageExt.IO.lift(() =>
                {
                    double elapsed = ElapsedTimeCalculator.CalculateElapsedMilliseconds(startTimestamp);
                    responseLogSuccess(requestHandler, requestHandlerMethod, result, elapsed);
                    RecordSpanSuccess(span, elapsed);
                    return global::LanguageExt.Unit.Default;
                })
                select result)
            .IfFail(error =>
                HandleOperationFailure<A>(requestHandler, requestHandlerMethod, error, span, startTimestamp, responseLogFailure));

    private global::LanguageExt.IO<A> HandleOperationFailure<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        ISpan? span,
        long startTimestamp,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure)
    {
        double elapsed = ElapsedTimeCalculator.CalculateElapsedMilliseconds(startTimestamp);
        responseLogFailure(requestHandler, requestHandlerMethod, error, elapsed);
        RecordSpanFailure(span, error, elapsed);
        return global::LanguageExt.IO.fail<A>(error);
    }

    private global::LanguageExt.IO<ISpan?> AcquireSpan(string requestHandler, string requestHandlerMethod) =>
        global::LanguageExt.IO.lift(() =>
        {
            string operationName = ObservabilityNaming.Spans.OperationName(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod);

            ISpan? span = _spanFactory.CreateChildSpan(
                _parentContext,
                operationName,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod);

            _metricRecorder.RecordRequest(
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod);

            return span;
        });

    private void RecordSpanSuccess(ISpan? span, double elapsed)
    {
        _metricRecorder.RecordResponseSuccess(this.GetRequestCategoryPascalCase(), RequestHandler, "Method", elapsed);
        span?.SetSuccess(elapsed);
    }

    private void RecordSpanFailure(ISpan? span, global::LanguageExt.Common.Error error, double elapsed)
    {
        _metricRecorder.RecordResponseFailure(this.GetRequestCategoryPascalCase(), RequestHandler, "Method", elapsed, error);
        span?.SetFailure(error, elapsed);
    }

    private string GetRequestCategoryPascalCase() =>
        string.IsNullOrEmpty(this.RequestCategory)
            ? string.Empty
            : char.ToUpper(this.RequestCategory[0]) + this.RequestCategory.Substring(1).ToLower();

    public override global::LanguageExt.FinT<global::LanguageExt.IO, string> GetConnection(
    ) =>
        global::LanguageExt.FinT.lift<global::LanguageExt.IO, string>(
            (from result in ExecuteWithSpan(
                requestHandler: RequestHandler,
                requestHandlerMethod: nameof(GetConnection),
                operation: FinTToIO(base.GetConnection()),
                requestLog: () => RequestLog_DerivedAdapter_GetConnection(RequestHandler, nameof(GetConnection)),
                responseLogSuccess: ResponseLogSuccess_DerivedAdapter_GetConnection,
                responseLogFailure: ResponseLogFailure_DerivedAdapter_GetConnection,
                startTimestamp: ElapsedTimeCalculator.GetCurrentTimestamp())
            select result).Map(r => global::LanguageExt.Fin.Succ(r)));

    private global::LanguageExt.IO<global::LanguageExt.Unit> RequestLog_DerivedAdapter_GetConnection(
        string requestHandler,
        string requestHandlerMethod) =>
        global::LanguageExt.IO.lift(() =>
        {
            if (_isDebugEnabled)
            {
                _logger.LogRequestDebug_DerivedAdapter_GetConnection(
                    ObservabilityNaming.Layers.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod);
            }
            else if (_isInformationEnabled)
            {
                _logger.LogRequest_DerivedAdapter_GetConnection(
                    ObservabilityNaming.Layers.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod);
            }
            return global::LanguageExt.Unit.Default;
        });

    private void ResponseLogSuccess_DerivedAdapter_GetConnection(
        string requestHandler,
        string requestHandlerMethod,
        string result,
        double elapsed)
    {
        if (_isDebugEnabled)
        {
            _logger.LogResponseDebug_DerivedAdapter_GetConnection(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Success,
                result,
                elapsed);
        }
        else if (_isInformationEnabled)
        {
            _logger.LogResponse_DerivedAdapter_GetConnection(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Success,
                elapsed);
        }
    }

    private void ResponseLogFailure_DerivedAdapter_GetConnection(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        double elapsed)
    {
        if (error.IsExceptional && _isErrorEnabled)
        {
            _logger.LogResponseError_DerivedAdapter_GetConnection(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Failure,
                elapsed,
                error);
        }
        else if (_isWarningEnabled)
        {
            _logger.LogResponseWarning_DerivedAdapter_GetConnection(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Failure,
                elapsed,
                error);
        }
    }
}

internal static class DerivedAdapterPipelineLoggers
{

    // ===== LoggerMessage.Define delegates for GetConnection =====
    private static readonly global::System.Action<ILogger, string, string, string, string, global::System.Exception?> _logRequest_DerivedAdapter_GetConnection =
        LoggerMessage.Define<string, string, string, string>(
            LogLevel.Information,
            ObservabilityNaming.EventIds.Adapter.AdapterRequest,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, global::System.Exception?> _logRequestDebug_DerivedAdapter_GetConnection =
        LoggerMessage.Define<string, string, string, string>(
            LogLevel.Debug,
            ObservabilityNaming.EventIds.Adapter.AdapterRequest,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, string, double, global::System.Exception?> _logResponse_DerivedAdapter_GetConnection =
        LoggerMessage.Define<string, string, string, string, string, double>(
            LogLevel.Information,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseSuccess,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} responded {Status} in {Elapsed:0.0000} ms");

    private static readonly global::System.Action<ILogger, string, string, string, string, double, global::LanguageExt.Common.Error, global::System.Exception?> _logResponseWarning_DerivedAdapter_GetConnection =
        LoggerMessage.Define<string, string, string, string, double, global::LanguageExt.Common.Error>(
            LogLevel.Warning,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseWarning,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} responded failure in {Elapsed:0.0000} ms with {@Error}");

    private static readonly global::System.Action<ILogger, string, string, string, string, double, global::LanguageExt.Common.Error, global::System.Exception?> _logResponseError_DerivedAdapter_GetConnection =
        LoggerMessage.Define<string, string, string, string, double, global::LanguageExt.Common.Error>(
            LogLevel.Error,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseError,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} responded failure in {Elapsed:0.0000} ms with {@Error}");


    public static void LogRequestDebug_DerivedAdapter_GetConnection(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        _logRequestDebug_DerivedAdapter_GetConnection(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, null);
    }

    public static void LogRequest_DerivedAdapter_GetConnection(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logRequest_DerivedAdapter_GetConnection(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, null);
    }

    public static void LogResponseDebug_DerivedAdapter_GetConnection(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        string result,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        logger.LogDebug(
            eventId: ObservabilityNaming.EventIds.Adapter.AdapterResponseSuccess,
            message: "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} " +
                     "{Response_Result} " +
                     "responded {Status} in {Elapsed:0.0000} ms",
            requestLayer, requestCategory, requestHandler, requestHandlerMethod, result, status, elapsed);
    }

    public static void LogResponse_DerivedAdapter_GetConnection(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logResponse_DerivedAdapter_GetConnection(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, status, elapsed, null);
    }

    public static void LogResponseWarning_DerivedAdapter_GetConnection(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Warning))
            return;

        _logResponseWarning_DerivedAdapter_GetConnection(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, elapsed, error, null);
    }

    public static void LogResponseError_DerivedAdapter_GetConnection(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Error))
            return;

        _logResponseError_DerivedAdapter_GetConnection(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, elapsed, error, null);
    }
}

