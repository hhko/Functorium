//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by source generator
//
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#nullable enable

using System.Diagnostics;
using System.Diagnostics.Metrics;
using Functorium.Adapters.Observabilities;
using Functorium.Adapters.Observabilities.Naming;
using Functorium.Applications.Observabilities;

using LanguageExt;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;

namespace TestNamespace;

public class TupleWithCollectionInputAdapterPipeline : TupleWithCollectionInputAdapter
{
    private readonly ActivitySource _activitySource;
    private readonly ILogger<TupleWithCollectionInputAdapterPipeline> _logger;

    // Metrics
    private readonly Counter<long> _requestCounter;
    private readonly Counter<long> _responseCounter;
    private readonly Histogram<double> _durationHistogram;

    private const string RequestHandler = nameof(TupleWithCollectionInputAdapter);

    private readonly bool _isDebugEnabled;
    private readonly bool _isInformationEnabled;
    private readonly bool _isWarningEnabled;
    private readonly bool _isErrorEnabled;

    public TupleWithCollectionInputAdapterPipeline(
        ActivitySource activitySource,
        ILogger<TupleWithCollectionInputAdapterPipeline> logger,
        IMeterFactory meterFactory,
        IOptions<OpenTelemetryOptions> openTelemetryOptions)

    {
        global::System.ArgumentNullException.ThrowIfNull(activitySource);
        global::System.ArgumentNullException.ThrowIfNull(meterFactory);
        global::System.ArgumentNullException.ThrowIfNull(openTelemetryOptions);

        _activitySource = activitySource;
        _logger = logger;

        // Meter 및 Metrics 초기화
        // Meter 이름: {service.namespace}.adapter.{category}
        string serviceNamespace = openTelemetryOptions.Value.ServiceNamespace;
        string categoryLower = this.RequestCategory?.ToLowerInvariant() ?? "adapter";
        string meterName = $"{serviceNamespace}.adapter.{categoryLower}";
        var meter = meterFactory.Create(meterName);
        _requestCounter = meter.CreateCounter<long>($"adapter.{categoryLower}.requests", "{request}", "Total number of adapter requests");
        _responseCounter = meter.CreateCounter<long>($"adapter.{categoryLower}.responses", "{response}", "Total number of adapter responses");
        _durationHistogram = meter.CreateHistogram<double>($"adapter.{categoryLower}.duration", "s", "Duration of adapter execution in seconds");

        _isDebugEnabled = logger.IsEnabled(LogLevel.Debug);
        _isInformationEnabled = logger.IsEnabled(LogLevel.Information);
        _isWarningEnabled = logger.IsEnabled(LogLevel.Warning);
        _isErrorEnabled = logger.IsEnabled(LogLevel.Error);
    }

    private static global::LanguageExt.IO<A> FinTToIO<A>(global::LanguageExt.FinT<global::LanguageExt.IO, A> finT) =>
        ((global::LanguageExt.IO<global::LanguageExt.IO<A>>)finT.Match(
            Succ: value => global::LanguageExt.IO.pure(value),
            Fail: global::LanguageExt.IO.fail<A>
        )).Flatten();

    private global::LanguageExt.IO<A> ExecuteWithSpan<A>(
            string requestHandler,
            string requestHandlerMethod,
            global::LanguageExt.IO<A> operation,
            global::System.Func<global::LanguageExt.IO<global::LanguageExt.Unit>> requestLog,
            global::System.Action<string, string, A, double> responseLogSuccess,
            global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
            long startTimestamp) =>
        AcquireActivity(requestHandler, requestHandlerMethod)
            .Bracket(
                Use: activity =>
                    from _logged in requestLog()
                    from result in ExecuteOperationWithErrorHandling(
                        requestHandler,
                        requestHandlerMethod,
                        operation,
                        activity,
                        responseLogSuccess,
                        responseLogFailure,
                        startTimestamp)
                    select result,
                Fin: activity => global::LanguageExt.IO.lift(() =>
                {
                    activity?.Dispose();
                    return global::LanguageExt.Unit.Default;
                }));

    private global::LanguageExt.IO<A> ExecuteOperationWithErrorHandling<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.IO<A> operation,
        Activity? activity,
        global::System.Action<string, string, A, double> responseLogSuccess,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
        long startTimestamp) =>
        operation
            .Bind(result =>
                from _ in global::LanguageExt.IO.lift(() =>
                {
                    double elapsed = ElapsedTimeCalculator.CalculateElapsedSeconds(startTimestamp);
                    responseLogSuccess(requestHandler, requestHandlerMethod, result, elapsed);
                    RecordActivitySuccess(activity, requestHandlerMethod, elapsed);
                    return global::LanguageExt.Unit.Default;
                })
                select result)
            .IfFail(error =>
                HandleOperationFailure<A>(requestHandler, requestHandlerMethod, error, activity, startTimestamp, responseLogFailure));

    private global::LanguageExt.IO<A> HandleOperationFailure<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        Activity? activity,
        long startTimestamp,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure)
    {
        double elapsed = ElapsedTimeCalculator.CalculateElapsedSeconds(startTimestamp);
        responseLogFailure(requestHandler, requestHandlerMethod, error, elapsed);
        RecordActivityFailure(activity, requestHandlerMethod, error, elapsed);
        return global::LanguageExt.IO.fail<A>(error);
    }

    private global::LanguageExt.IO<Activity?> AcquireActivity(string requestHandler, string requestHandlerMethod) =>
        global::LanguageExt.IO.lift(() =>
        {
            string operationName = ObservabilityNaming.Spans.OperationName(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod);

            // TagList: 구조체로 스택에 할당되어 GC 부담 최소화
            TagList tags = new()
            {
                { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
                { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
                { ObservabilityNaming.CustomAttributes.RequestHandler, requestHandler },
                { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, requestHandlerMethod }
            };

            // Activity.Current를 부모로 사용 (표준 OpenTelemetry 동작)
            var parentContext = Activity.Current?.Context ?? default;
            var activity = _activitySource.StartActivity(
                operationName,
                ActivityKind.Internal,
                parentContext,
                tags);

            // Metrics 기록
            TagList metricTags = new()
            {
                { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
                { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
                { ObservabilityNaming.CustomAttributes.RequestHandler, requestHandler },
                { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, requestHandlerMethod }
            };
            _requestCounter.Add(1, metricTags);

            return activity;
        });

    private void RecordActivitySuccess(Activity? activity, string requestHandlerMethod, double elapsed)
    {
        TagList metricTags = new()
        {
            { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
            { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
            { ObservabilityNaming.CustomAttributes.RequestHandler, RequestHandler },
            { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, requestHandlerMethod },
            { ObservabilityNaming.CustomAttributes.ResponseStatus, ObservabilityNaming.Status.Success }
        };
        _responseCounter.Add(1, metricTags);
        _durationHistogram.Record(elapsed, metricTags);

        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseElapsed, elapsed);
        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseStatus, ObservabilityNaming.Status.Success);
        activity?.SetStatus(ActivityStatusCode.Ok);
    }

    private void RecordActivityFailure(Activity? activity, string requestHandlerMethod, global::LanguageExt.Common.Error error, double elapsed)
    {
        var (errorType, errorCode) = GetErrorInfo(error);

        TagList metricTags = new()
        {
            { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
            { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
            { ObservabilityNaming.CustomAttributes.RequestHandler, RequestHandler },
            { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, requestHandlerMethod },
            { ObservabilityNaming.CustomAttributes.ResponseStatus, ObservabilityNaming.Status.Failure },
            { ObservabilityNaming.OTelAttributes.ErrorType, errorType },
            { ObservabilityNaming.CustomAttributes.ErrorCode, errorCode }
        };
        _responseCounter.Add(1, metricTags);
        _durationHistogram.Record(elapsed, metricTags);

        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseElapsed, elapsed);
        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseStatus, ObservabilityNaming.Status.Failure);
        activity?.SetTag(ObservabilityNaming.OTelAttributes.ErrorType, errorType);
        activity?.SetTag(ObservabilityNaming.CustomAttributes.ErrorCode, errorCode);
        activity?.SetStatus(ActivityStatusCode.Error, $"{errorType}: {errorCode}");
    }

    private string GetRequestCategoryPascalCase() =>
        string.IsNullOrEmpty(this.RequestCategory)
            ? string.Empty
            : char.ToUpper(this.RequestCategory[0]) + this.RequestCategory.Substring(1).ToLower();

    /// <summary>
    /// 에러 정보(타입, 코드)를 추출합니다.
    /// </summary>
    private static (string ErrorType, string ErrorCode) GetErrorInfo(global::LanguageExt.Common.Error error)
    {
        return error switch
        {
            // ManyErrors - 복합 에러
            global::LanguageExt.Common.ManyErrors many => (
                ErrorType: ObservabilityNaming.ErrorTypes.Aggregate,
                ErrorCode: GetPrimaryErrorCode(many)
            ),
            // IHasErrorCode - ErrorCode가 있는 에러 (IsExceptional로 타입 구분)
            global::Functorium.Abstractions.Errors.IHasErrorCode hasErrorCode => (
                ErrorType: error.IsExceptional
                    ? ObservabilityNaming.ErrorTypes.Exceptional
                    : ObservabilityNaming.ErrorTypes.Expected,
                ErrorCode: hasErrorCode.ErrorCode
            ),
            // Fallback - 알 수 없는 에러 타입
            _ => (
                ErrorType: error.IsExceptional
                    ? ObservabilityNaming.ErrorTypes.Exceptional
                    : ObservabilityNaming.ErrorTypes.Expected,
                ErrorCode: error.GetType().Name
            )
        };
    }

    /// <summary>
    /// ManyErrors에서 대표 에러 코드를 선정합니다.
    /// 우선순위: Exceptional > First > "ManyErrors"
    /// </summary>
    private static string GetPrimaryErrorCode(global::LanguageExt.Common.ManyErrors many)
    {
        // 1순위: Exceptional 에러 (시스템 에러가 더 심각)
        foreach (var e in many.Errors)
        {
            if (e.IsExceptional)
                return GetErrorCode(e);
        }

        // 2순위: 첫 번째 에러
        return many.Errors.Head.Match(
            Some: GetErrorCode,
            None: () => nameof(global::LanguageExt.Common.ManyErrors));
    }

    /// <summary>
    /// 단일 에러에서 에러 코드를 추출합니다.
    /// </summary>
    private static string GetErrorCode(global::LanguageExt.Common.Error error)
    {
        return error switch
        {
            global::Functorium.Abstractions.Errors.IHasErrorCode hasErrorCode => hasErrorCode.ErrorCode,
            _ => error.GetType().Name
        };
    }

    public override global::LanguageExt.FinT<global::LanguageExt.IO, int> ProcessUserWithTags(
        (int Id, global::System.Collections.Generic.List<string> Tags) user
    ) =>
        global::LanguageExt.FinT.lift<global::LanguageExt.IO, int>(
            (from result in ExecuteWithSpan(
                requestHandler: RequestHandler,
                requestHandlerMethod: nameof(ProcessUserWithTags),
                operation: FinTToIO(base.ProcessUserWithTags(user)),
                requestLog: () => RequestLog_TupleWithCollectionInputAdapter_ProcessUserWithTags(RequestHandler, nameof(ProcessUserWithTags), user),
                responseLogSuccess: ResponseLogSuccess_TupleWithCollectionInputAdapter_ProcessUserWithTags,
                responseLogFailure: ResponseLogFailure_TupleWithCollectionInputAdapter_ProcessUserWithTags,
                startTimestamp: ElapsedTimeCalculator.GetCurrentTimestamp())
            select result).Map(r => global::LanguageExt.Fin.Succ(r)));

    private global::LanguageExt.IO<global::LanguageExt.Unit> RequestLog_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        string requestHandler,
        string requestHandlerMethod,
        (int Id, global::System.Collections.Generic.List<string> Tags) user) =>
        global::LanguageExt.IO.lift(() =>
        {
            if (_isDebugEnabled)
            {
                _logger.LogRequestDebug_TupleWithCollectionInputAdapter_ProcessUserWithTags(
                    ObservabilityNaming.Layers.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod,
                    user);
            }
            else if (_isInformationEnabled)
            {
                _logger.LogRequest_TupleWithCollectionInputAdapter_ProcessUserWithTags(
                    ObservabilityNaming.Layers.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod);
            }
            return global::LanguageExt.Unit.Default;
        });

    private void ResponseLogSuccess_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        string requestHandler,
        string requestHandlerMethod,
        int result,
        double elapsed)
    {
        if (_isDebugEnabled)
        {
            _logger.LogResponseDebug_TupleWithCollectionInputAdapter_ProcessUserWithTags(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Success,
                result,
                elapsed);
        }
        else if (_isInformationEnabled)
        {
            _logger.LogResponse_TupleWithCollectionInputAdapter_ProcessUserWithTags(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Success,
                elapsed);
        }
    }

    private void ResponseLogFailure_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        double elapsed)
    {
        var (errorType, errorCode) = GetErrorInfo(error);

        if (error.IsExceptional && _isErrorEnabled)
        {
            _logger.LogResponseError_TupleWithCollectionInputAdapter_ProcessUserWithTags(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Failure,
                elapsed,
                errorType,
                errorCode,
                error);
        }
        else if (_isWarningEnabled)
        {
            _logger.LogResponseWarning_TupleWithCollectionInputAdapter_ProcessUserWithTags(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Failure,
                elapsed,
                errorType,
                errorCode,
                error);
        }
    }
}

internal static class TupleWithCollectionInputAdapterPipelineLoggers
{

    // ===== LoggerMessage.Define delegates for ProcessUserWithTags =====
    private static readonly global::System.Action<ILogger, string, string, string, string, global::System.Exception?> _logRequest_TupleWithCollectionInputAdapter_ProcessUserWithTags =
        LoggerMessage.Define<string, string, string, string>(
            LogLevel.Information,
            ObservabilityNaming.EventIds.Adapter.AdapterRequest,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, (int Id, global::System.Collections.Generic.List<string> Tags), global::System.Exception?> _logRequestDebug_TupleWithCollectionInputAdapter_ProcessUserWithTags =
        LoggerMessage.Define<string, string, string, string, (int Id, global::System.Collections.Generic.List<string> Tags)>(
            LogLevel.Debug,
            ObservabilityNaming.EventIds.Adapter.AdapterRequest,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} {request.params.user} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, string, double, global::System.Exception?> _logResponse_TupleWithCollectionInputAdapter_ProcessUserWithTags =
        LoggerMessage.Define<string, string, string, string, string, double>(
            LogLevel.Information,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseSuccess,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} responded {response.status} in {response.elapsed:0.0000} s");


    public static void LogRequestDebug_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        (int Id, global::System.Collections.Generic.List<string> Tags) user)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        _logRequestDebug_TupleWithCollectionInputAdapter_ProcessUserWithTags(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, user, null);
    }

    public static void LogRequest_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logRequest_TupleWithCollectionInputAdapter_ProcessUserWithTags(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, null);
    }

    public static void LogResponseDebug_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        int result,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        logger.LogDebug(
            eventId: ObservabilityNaming.EventIds.Adapter.AdapterResponseSuccess,
            message: "{request.layer} {request.category} {request.handler}.{request.handler.method} " +
                     "{response.result} " +
                     "responded {response.status} in {response.elapsed:0.0000} s",
            requestLayer, requestCategory, requestHandler, requestHandlerMethod, result, status, elapsed);
    }

    public static void LogResponse_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logResponse_TupleWithCollectionInputAdapter_ProcessUserWithTags(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, status, elapsed, null);
    }

    public static void LogResponseWarning_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        string errorType,
        string errorCode,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Warning))
            return;

        logger.LogWarning(
            ObservabilityNaming.EventIds.Adapter.AdapterResponseWarning,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} responded failure in {response.elapsed:0.0000} s with {error.type}:{error.code} {@error}",
            requestLayer,
            requestCategory,
            requestHandler,
            requestHandlerMethod,
            elapsed,
            errorType,
            errorCode,
            error);
    }

    public static void LogResponseError_TupleWithCollectionInputAdapter_ProcessUserWithTags(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        string errorType,
        string errorCode,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Error))
            return;

        logger.LogError(
            ObservabilityNaming.EventIds.Adapter.AdapterResponseError,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} responded failure in {response.elapsed:0.0000} s with {error.type}:{error.code} {@error}",
            requestLayer,
            requestCategory,
            requestHandler,
            requestHandlerMethod,
            elapsed,
            errorType,
            errorCode,
            error);
    }
}

