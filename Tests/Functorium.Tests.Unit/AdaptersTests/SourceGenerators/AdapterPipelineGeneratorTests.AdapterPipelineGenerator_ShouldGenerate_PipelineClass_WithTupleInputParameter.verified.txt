//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by source generator
//
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#nullable enable

using Functorium.Abstractions;
using Functorium.Applications.Observabilities;

using LanguageExt;
using Microsoft.Extensions.Logging;
using System.Diagnostics;

using ObservabilityFields = Functorium.Adapters.Observabilities.ObservabilityFields;

namespace TestNamespace;

public class TupleInputAdapterPipeline : TupleInputAdapter
{
    private readonly ActivityContext _parentContext;

    private readonly ILogger<TupleInputAdapterPipeline> _logger;
    private readonly IAdapterTrace _adapterTrace;
    private readonly IAdapterMetric _adapterMetric;

    private const string RequestHandler = nameof(TupleInputAdapter);

    private readonly bool _isDebugEnabled;
    private readonly bool _isInformationEnabled;
    private readonly bool _isWarningEnabled;
    private readonly bool _isErrorEnabled;

    public TupleInputAdapterPipeline(
        ActivityContext parentContext,
        ILogger<TupleInputAdapterPipeline> logger,
        IAdapterTrace adapterTrace,
        IAdapterMetric adapterMetric)

    {
        global::System.ArgumentNullException.ThrowIfNull(adapterTrace);
        global::System.ArgumentNullException.ThrowIfNull(adapterMetric);

        _parentContext = parentContext;
        _logger = logger;
        _adapterTrace = adapterTrace;
        _adapterMetric = adapterMetric;

        _isDebugEnabled = logger.IsEnabled(LogLevel.Debug);
        _isInformationEnabled = logger.IsEnabled(LogLevel.Information);
        _isWarningEnabled = logger.IsEnabled(LogLevel.Warning);
        _isErrorEnabled = logger.IsEnabled(LogLevel.Error);
    }

    private static global::LanguageExt.IO<A> FinTToIO<A>(global::LanguageExt.FinT<global::LanguageExt.IO, A> finT) =>
        ((global::LanguageExt.IO<global::LanguageExt.IO<A>>)finT.Match(
            Succ: value => global::LanguageExt.IO.pure(value),
            Fail: global::LanguageExt.IO.fail<A>
        )).Flatten();

    private global::LanguageExt.IO<A> ExecuteWithActivity<A>(
            string requestHandler,
            string requestHandlerMethod,
            global::LanguageExt.IO<A> operation,
            global::System.Func<global::LanguageExt.IO<global::LanguageExt.Unit>> requestLog,
            global::System.Action<string, string, A, double> responseLogSuccess,
            global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
            long startTimestamp) =>
        AcquireActivity(requestHandler, requestHandlerMethod, startTimestamp)
            .Bracket(
                Use: activity =>
                    from _setContext in global::LanguageExt.IO.pure(global::Functorium.Applications.TraceParentContextHolder.SetCurrentUnit(_parentContext))
                    from _logged in requestLog()
                    from result in ExecuteOperationWithErrorHandling(
                        requestHandler,
                        requestHandlerMethod,
                        operation,
                        activity,
                        responseLogSuccess,
                        responseLogFailure,
                        startTimestamp)
                    select result,
                Fin: activity => global::LanguageExt.IO.lift(() =>
                {
                    global::Functorium.Applications.TraceParentContextHolder.SetCurrent(null);
                    activity?.Stop();
                    activity?.Dispose();
                    Activity.Current = null;
                    return global::LanguageExt.Unit.Default;
                }));

    private global::LanguageExt.IO<A> ExecuteOperationWithErrorHandling<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.IO<A> operation,
        Activity? activity,
        global::System.Action<string, string, A, double> responseLogSuccess,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
        long startTimestamp) =>
        operation
            .Bind(result =>
                from _ in global::LanguageExt.IO.lift(() =>
                {
                    double elapsed = ElapsedTimeCalculator.CalculateElapsedMilliseconds(startTimestamp);
                    responseLogSuccess(requestHandler, requestHandlerMethod, result, elapsed);
                    ResponseActivitySuccess(activity, elapsed);
                    return global::LanguageExt.Unit.Default;
                })
                select result)
            .IfFail(error =>
                HandleOperationFailure<A>(requestHandler, requestHandlerMethod, error, activity, startTimestamp, responseLogFailure));

    private global::LanguageExt.IO<A> HandleOperationFailure<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        Activity? activity,
        long startTimestamp,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure)
    {
        double elapsed = ElapsedTimeCalculator.CalculateElapsedMilliseconds(startTimestamp);
        responseLogFailure(requestHandler, requestHandlerMethod, error, elapsed);
        ResponseActivityFailure(activity, error, elapsed);
        return global::LanguageExt.IO.fail<A>(error);
    }

    private global::LanguageExt.IO<Activity?> AcquireActivity(string requestHandler, string requestHandlerMethod, long startTimestamp) =>
        global::LanguageExt.IO.lift(() =>
        {
            DateTimeOffset startTime = DateTimeOffset.UtcNow;
            Activity? activity = _adapterTrace.Request(
                _parentContext,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                startTime);

            _adapterMetric.Request(
                activity,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                startTime);

            return activity;
        });

    private void ResponseActivitySuccess(Activity? activity, double elapsed)
    {
        _adapterMetric.ResponseSuccess(activity, this.GetRequestCategoryPascalCase(), elapsed);
        _adapterTrace.ResponseSuccess(activity, elapsed);
    }

    private void ResponseActivityFailure(Activity? activity, global::LanguageExt.Common.Error error, double elapsed)
    {
        _adapterMetric.ResponseFailure(activity, this.GetRequestCategoryPascalCase(), elapsed, error);
        _adapterTrace.ResponseFailure(activity, elapsed, error);
    }

    private string GetRequestCategoryPascalCase() =>
        string.IsNullOrEmpty(this.RequestCategory)
            ? string.Empty
            : char.ToUpper(this.RequestCategory[0]) + this.RequestCategory.Substring(1).ToLower();

    public override global::LanguageExt.FinT<global::LanguageExt.IO, string> ProcessUser(
        (int Id, string Name) user
    ) =>
        global::LanguageExt.FinT.lift<global::LanguageExt.IO, string>(
            (from result in ExecuteWithActivity(
                requestHandler: RequestHandler,
                requestHandlerMethod: nameof(ProcessUser),
                operation: FinTToIO(base.ProcessUser(user)),
                requestLog: () => RequestLog_TupleInputAdapter_ProcessUser(RequestHandler, nameof(ProcessUser), user),
                responseLogSuccess: ResponseLogSuccess_TupleInputAdapter_ProcessUser,
                responseLogFailure: ResponseLogFailure_TupleInputAdapter_ProcessUser,
                startTimestamp: ElapsedTimeCalculator.GetCurrentTimestamp())
            select result).Map(r => global::LanguageExt.Fin.Succ(r)));

    private global::LanguageExt.IO<global::LanguageExt.Unit> RequestLog_TupleInputAdapter_ProcessUser(
        string requestHandler,
        string requestHandlerMethod,
        (int Id, string Name) user) =>
        global::LanguageExt.IO.lift(() =>
        {
            if (_isDebugEnabled)
            {
                _logger.LogRequestDebug_TupleInputAdapter_ProcessUser(
                    ObservabilityFields.Request.Layer.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod,
                    user);
            }
            else if (_isInformationEnabled)
            {
                _logger.LogRequest_TupleInputAdapter_ProcessUser(
                    ObservabilityFields.Request.Layer.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod);
            }
            return global::LanguageExt.Unit.Default;
        });

    private void ResponseLogSuccess_TupleInputAdapter_ProcessUser(
        string requestHandler,
        string requestHandlerMethod,
        string result,
        double elapsed)
    {
        if (_isDebugEnabled)
        {
            _logger.LogResponseDebug_TupleInputAdapter_ProcessUser(
                ObservabilityFields.Request.Layer.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityFields.Response.Status.Success,
                result,
                elapsed);
        }
        else if (_isInformationEnabled)
        {
            _logger.LogResponse_TupleInputAdapter_ProcessUser(
                ObservabilityFields.Request.Layer.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityFields.Response.Status.Success,
                elapsed);
        }
    }

    private void ResponseLogFailure_TupleInputAdapter_ProcessUser(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        double elapsed)
    {
        if (error.IsExceptional && _isErrorEnabled)
        {
            _logger.LogResponseError_TupleInputAdapter_ProcessUser(
                ObservabilityFields.Request.Layer.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityFields.Response.Status.Failure,
                elapsed,
                error);
        }
        else if (_isWarningEnabled)
        {
            _logger.LogResponseWarning_TupleInputAdapter_ProcessUser(
                ObservabilityFields.Request.Layer.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityFields.Response.Status.Failure,
                elapsed,
                error);
        }
    }
}

internal static class TupleInputAdapterPipelineLoggers
{

    // ===== LoggerMessage.Define delegates for ProcessUser =====
    private static readonly global::System.Action<ILogger, string, string, string, string, global::System.Exception?> _logRequest_TupleInputAdapter_ProcessUser =
        LoggerMessage.Define<string, string, string, string>(
            LogLevel.Information,
            ObservabilityFields.EventIds.Adapter.AdapterRequest,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, (int Id, string Name), global::System.Exception?> _logRequestDebug_TupleInputAdapter_ProcessUser =
        LoggerMessage.Define<string, string, string, string, (int Id, string Name)>(
            LogLevel.Debug,
            ObservabilityFields.EventIds.Adapter.AdapterRequest,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} {Request_User} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, string, double, global::System.Exception?> _logResponse_TupleInputAdapter_ProcessUser =
        LoggerMessage.Define<string, string, string, string, string, double>(
            LogLevel.Information,
            ObservabilityFields.EventIds.Adapter.AdapterResponseSuccess,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} responded {Status} in {Elapsed:0.0000} ms");

    private static readonly global::System.Action<ILogger, string, string, string, string, double, global::LanguageExt.Common.Error, global::System.Exception?> _logResponseWarning_TupleInputAdapter_ProcessUser =
        LoggerMessage.Define<string, string, string, string, double, global::LanguageExt.Common.Error>(
            LogLevel.Warning,
            ObservabilityFields.EventIds.Adapter.AdapterResponseWarning,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} responded failure in {Elapsed:0.0000} ms with {@Error}");

    private static readonly global::System.Action<ILogger, string, string, string, string, double, global::LanguageExt.Common.Error, global::System.Exception?> _logResponseError_TupleInputAdapter_ProcessUser =
        LoggerMessage.Define<string, string, string, string, double, global::LanguageExt.Common.Error>(
            LogLevel.Error,
            ObservabilityFields.EventIds.Adapter.AdapterResponseError,
            "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} responded failure in {Elapsed:0.0000} ms with {@Error}");


    public static void LogRequestDebug_TupleInputAdapter_ProcessUser(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        (int Id, string Name) user)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        _logRequestDebug_TupleInputAdapter_ProcessUser(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, user, null);
    }

    public static void LogRequest_TupleInputAdapter_ProcessUser(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logRequest_TupleInputAdapter_ProcessUser(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, null);
    }

    public static void LogResponseDebug_TupleInputAdapter_ProcessUser(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        string result,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        logger.LogDebug(
            eventId: ObservabilityFields.EventIds.Adapter.AdapterResponseSuccess,
            message: "{RequestLayer} {RequestCategory} {RequestHandler}.{RequestHandlerMethod} " +
                     "{Response_Result} " +
                     "responded {Status} in {Elapsed:0.0000} ms",
            requestLayer, requestCategory, requestHandler, requestHandlerMethod, result, status, elapsed);
    }

    public static void LogResponse_TupleInputAdapter_ProcessUser(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logResponse_TupleInputAdapter_ProcessUser(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, status, elapsed, null);
    }

    public static void LogResponseWarning_TupleInputAdapter_ProcessUser(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Warning))
            return;

        _logResponseWarning_TupleInputAdapter_ProcessUser(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, elapsed, error, null);
    }

    public static void LogResponseError_TupleInputAdapter_ProcessUser(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Error))
            return;

        _logResponseError_TupleInputAdapter_ProcessUser(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, elapsed, error, null);
    }
}

