//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by source generator
//
//     Changes to this file may cause incorrect behavior and will be lost if the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

#nullable enable

using System.Diagnostics;
using System.Diagnostics.Metrics;
using Functorium.Abstractions;
using Functorium.Adapters.Observabilities.Naming;
using Functorium.Applications.Observabilities;

using LanguageExt;
using Microsoft.Extensions.Logging;

namespace TestNamespace;

public class ThreeParamAdapterPipeline : ThreeParamAdapter
{
    private readonly ActivitySource _activitySource;
    private readonly ILogger<ThreeParamAdapterPipeline> _logger;

    // Metrics
    private readonly Counter<long> _requestCounter;
    private readonly Counter<long> _successCounter;
    private readonly Counter<long> _failureCounter;
    private readonly Histogram<double> _durationHistogram;

    private const string RequestHandler = nameof(ThreeParamAdapter);

    private readonly bool _isDebugEnabled;
    private readonly bool _isInformationEnabled;
    private readonly bool _isWarningEnabled;
    private readonly bool _isErrorEnabled;

    public ThreeParamAdapterPipeline(
        ActivitySource activitySource,
        ILogger<ThreeParamAdapterPipeline> logger,
        IMeterFactory meterFactory)

    {
        global::System.ArgumentNullException.ThrowIfNull(activitySource);
        global::System.ArgumentNullException.ThrowIfNull(meterFactory);

        _activitySource = activitySource;
        _logger = logger;

        // Meter 및 Metrics 초기화
        string categoryLower = this.RequestCategory?.ToLowerInvariant() ?? "adapter";
        var meter = meterFactory.Create($"adapter.{categoryLower}");
        _requestCounter = meter.CreateCounter<long>($"adapter.{categoryLower}.requests", "{request}", "Total number of adapter requests");
        _successCounter = meter.CreateCounter<long>($"adapter.{categoryLower}.responses.success", "{response}", "Total number of successful responses");
        _failureCounter = meter.CreateCounter<long>($"adapter.{categoryLower}.responses.failure", "{response}", "Total number of failed responses");
        _durationHistogram = meter.CreateHistogram<double>($"adapter.{categoryLower}.duration", "s", "Duration of adapter execution in seconds");

        _isDebugEnabled = logger.IsEnabled(LogLevel.Debug);
        _isInformationEnabled = logger.IsEnabled(LogLevel.Information);
        _isWarningEnabled = logger.IsEnabled(LogLevel.Warning);
        _isErrorEnabled = logger.IsEnabled(LogLevel.Error);
    }

    private static global::LanguageExt.IO<A> FinTToIO<A>(global::LanguageExt.FinT<global::LanguageExt.IO, A> finT) =>
        ((global::LanguageExt.IO<global::LanguageExt.IO<A>>)finT.Match(
            Succ: value => global::LanguageExt.IO.pure(value),
            Fail: global::LanguageExt.IO.fail<A>
        )).Flatten();

    private global::LanguageExt.IO<A> ExecuteWithSpan<A>(
            string requestHandler,
            string requestHandlerMethod,
            global::LanguageExt.IO<A> operation,
            global::System.Func<global::LanguageExt.IO<global::LanguageExt.Unit>> requestLog,
            global::System.Action<string, string, A, double> responseLogSuccess,
            global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
            long startTimestamp) =>
        AcquireActivity(requestHandler, requestHandlerMethod)
            .Bracket(
                Use: activity =>
                    from _logged in requestLog()
                    from result in ExecuteOperationWithErrorHandling(
                        requestHandler,
                        requestHandlerMethod,
                        operation,
                        activity,
                        responseLogSuccess,
                        responseLogFailure,
                        startTimestamp)
                    select result,
                Fin: activity => global::LanguageExt.IO.lift(() =>
                {
                    activity?.Dispose();
                    return global::LanguageExt.Unit.Default;
                }));

    private global::LanguageExt.IO<A> ExecuteOperationWithErrorHandling<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.IO<A> operation,
        Activity? activity,
        global::System.Action<string, string, A, double> responseLogSuccess,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure,
        long startTimestamp) =>
        operation
            .Bind(result =>
                from _ in global::LanguageExt.IO.lift(() =>
                {
                    double elapsed = ElapsedTimeCalculator.CalculateElapsedMilliseconds(startTimestamp);
                    responseLogSuccess(requestHandler, requestHandlerMethod, result, elapsed);
                    RecordActivitySuccess(activity, elapsed);
                    return global::LanguageExt.Unit.Default;
                })
                select result)
            .IfFail(error =>
                HandleOperationFailure<A>(requestHandler, requestHandlerMethod, error, activity, startTimestamp, responseLogFailure));

    private global::LanguageExt.IO<A> HandleOperationFailure<A>(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        Activity? activity,
        long startTimestamp,
        global::System.Action<string, string, global::LanguageExt.Common.Error, double> responseLogFailure)
    {
        double elapsed = ElapsedTimeCalculator.CalculateElapsedMilliseconds(startTimestamp);
        responseLogFailure(requestHandler, requestHandlerMethod, error, elapsed);
        RecordActivityFailure(activity, error, elapsed);
        return global::LanguageExt.IO.fail<A>(error);
    }

    private global::LanguageExt.IO<Activity?> AcquireActivity(string requestHandler, string requestHandlerMethod) =>
        global::LanguageExt.IO.lift(() =>
        {
            string operationName = ObservabilityNaming.Spans.OperationName(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod);

            // TagList: 구조체로 스택에 할당되어 GC 부담 최소화
            TagList tags = new()
            {
                { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
                { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
                { ObservabilityNaming.CustomAttributes.RequestHandler, requestHandler },
                { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, requestHandlerMethod }
            };

            // Activity.Current를 부모로 사용 (표준 OpenTelemetry 동작)
            var parentContext = Activity.Current?.Context ?? default;
            var activity = _activitySource.StartActivity(
                operationName,
                ActivityKind.Internal,
                parentContext,
                tags);

            // Metrics 기록
            TagList metricTags = new()
            {
                { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
                { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
                { ObservabilityNaming.CustomAttributes.RequestHandler, requestHandler },
                { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, requestHandlerMethod }
            };
            _requestCounter.Add(1, metricTags);

            return activity;
        });

    private void RecordActivitySuccess(Activity? activity, double elapsed)
    {
        TagList metricTags = new()
        {
            { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
            { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
            { ObservabilityNaming.CustomAttributes.RequestHandler, RequestHandler },
            { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, "Method" }
        };
        _successCounter.Add(1, metricTags);
        _durationHistogram.Record(elapsed / 1000.0, metricTags); // ms to seconds

        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseElapsed, elapsed);
        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseStatus, ObservabilityNaming.Status.Success);
        activity?.SetStatus(ActivityStatusCode.Ok);
    }

    private void RecordActivityFailure(Activity? activity, global::LanguageExt.Common.Error error, double elapsed)
    {
        TagList metricTags = new()
        {
            { ObservabilityNaming.CustomAttributes.RequestLayer, ObservabilityNaming.Layers.Adapter },
            { ObservabilityNaming.CustomAttributes.RequestCategory, this.GetRequestCategoryPascalCase() },
            { ObservabilityNaming.CustomAttributes.RequestHandler, RequestHandler },
            { ObservabilityNaming.CustomAttributes.RequestHandlerMethod, "Method" }
        };
        _failureCounter.Add(1, metricTags);
        _durationHistogram.Record(elapsed / 1000.0, metricTags); // ms to seconds

        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseElapsed, elapsed);
        activity?.SetTag(ObservabilityNaming.CustomAttributes.ResponseStatus, ObservabilityNaming.Status.Failure);
        activity?.SetTag(ObservabilityNaming.CustomAttributes.ErrorMessage, error.Message);
        activity?.SetStatus(ActivityStatusCode.Error, error.Message);
    }

    private string GetRequestCategoryPascalCase() =>
        string.IsNullOrEmpty(this.RequestCategory)
            ? string.Empty
            : char.ToUpper(this.RequestCategory[0]) + this.RequestCategory.Substring(1).ToLower();

    public override global::LanguageExt.FinT<global::LanguageExt.IO, string> GetData(
        int id,
        string name,
        bool isActive
    ) =>
        global::LanguageExt.FinT.lift<global::LanguageExt.IO, string>(
            (from result in ExecuteWithSpan(
                requestHandler: RequestHandler,
                requestHandlerMethod: nameof(GetData),
                operation: FinTToIO(base.GetData(id, name, isActive)),
                requestLog: () => RequestLog_ThreeParamAdapter_GetData(RequestHandler, nameof(GetData), id, name, isActive),
                responseLogSuccess: ResponseLogSuccess_ThreeParamAdapter_GetData,
                responseLogFailure: ResponseLogFailure_ThreeParamAdapter_GetData,
                startTimestamp: ElapsedTimeCalculator.GetCurrentTimestamp())
            select result).Map(r => global::LanguageExt.Fin.Succ(r)));

    private global::LanguageExt.IO<global::LanguageExt.Unit> RequestLog_ThreeParamAdapter_GetData(
        string requestHandler,
        string requestHandlerMethod,
        int id,
        string name,
        bool isActive) =>
        global::LanguageExt.IO.lift(() =>
        {
            if (_isDebugEnabled)
            {
                _logger.LogRequestDebug_ThreeParamAdapter_GetData(
                    ObservabilityNaming.Layers.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod,
                    id, name, isActive);
            }
            else if (_isInformationEnabled)
            {
                _logger.LogRequest_ThreeParamAdapter_GetData(
                    ObservabilityNaming.Layers.Adapter,
                    this.GetRequestCategoryPascalCase(),
                    requestHandler,
                    requestHandlerMethod);
            }
            return global::LanguageExt.Unit.Default;
        });

    private void ResponseLogSuccess_ThreeParamAdapter_GetData(
        string requestHandler,
        string requestHandlerMethod,
        string result,
        double elapsed)
    {
        if (_isDebugEnabled)
        {
            _logger.LogResponseDebug_ThreeParamAdapter_GetData(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Success,
                result,
                elapsed);
        }
        else if (_isInformationEnabled)
        {
            _logger.LogResponse_ThreeParamAdapter_GetData(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Success,
                elapsed);
        }
    }

    private void ResponseLogFailure_ThreeParamAdapter_GetData(
        string requestHandler,
        string requestHandlerMethod,
        global::LanguageExt.Common.Error error,
        double elapsed)
    {
        if (error.IsExceptional && _isErrorEnabled)
        {
            _logger.LogResponseError_ThreeParamAdapter_GetData(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Failure,
                elapsed,
                error);
        }
        else if (_isWarningEnabled)
        {
            _logger.LogResponseWarning_ThreeParamAdapter_GetData(
                ObservabilityNaming.Layers.Adapter,
                this.GetRequestCategoryPascalCase(),
                requestHandler,
                requestHandlerMethod,
                ObservabilityNaming.Status.Failure,
                elapsed,
                error);
        }
    }
}

internal static class ThreeParamAdapterPipelineLoggers
{

    // ===== LoggerMessage.Define delegates for GetData =====
    private static readonly global::System.Action<ILogger, string, string, string, string, global::System.Exception?> _logRequest_ThreeParamAdapter_GetData =
        LoggerMessage.Define<string, string, string, string>(
            LogLevel.Information,
            ObservabilityNaming.EventIds.Adapter.AdapterRequest,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} requesting");

    private static readonly global::System.Action<ILogger, string, string, string, string, string, double, global::System.Exception?> _logResponse_ThreeParamAdapter_GetData =
        LoggerMessage.Define<string, string, string, string, string, double>(
            LogLevel.Information,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseSuccess,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} responded {status} in {elapsed:0.0000} ms");

    private static readonly global::System.Action<ILogger, string, string, string, string, double, global::LanguageExt.Common.Error, global::System.Exception?> _logResponseWarning_ThreeParamAdapter_GetData =
        LoggerMessage.Define<string, string, string, string, double, global::LanguageExt.Common.Error>(
            LogLevel.Warning,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseWarning,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} responded failure in {elapsed:0.0000} ms with {@error}");

    private static readonly global::System.Action<ILogger, string, string, string, string, double, global::LanguageExt.Common.Error, global::System.Exception?> _logResponseError_ThreeParamAdapter_GetData =
        LoggerMessage.Define<string, string, string, string, double, global::LanguageExt.Common.Error>(
            LogLevel.Error,
            ObservabilityNaming.EventIds.Adapter.AdapterResponseError,
            "{request.layer} {request.category} {request.handler}.{request.handler.method} responded failure in {elapsed:0.0000} ms with {@error}");


    public static void LogRequestDebug_ThreeParamAdapter_GetData(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        int id,
        string name,
        bool isActive)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        logger.LogDebug(
            eventId: ObservabilityNaming.EventIds.Adapter.AdapterRequest,
            message: "{request.layer} {request.category} {request.handler}.{request.handler.method} " +
                     "{request.params.id} {request.params.name} {request.params.isactive} " +
                     "requesting",
            requestLayer, requestCategory, requestHandler, requestHandlerMethod,
            id, name, isActive);
    }

    public static void LogRequest_ThreeParamAdapter_GetData(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logRequest_ThreeParamAdapter_GetData(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, null);
    }

    public static void LogResponseDebug_ThreeParamAdapter_GetData(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        string result,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Debug))
            return;

        logger.LogDebug(
            eventId: ObservabilityNaming.EventIds.Adapter.AdapterResponseSuccess,
            message: "{request.layer} {request.category} {request.handler}.{request.handler.method} " +
                     "{response.result} " +
                     "responded {status} in {elapsed:0.0000} ms",
            requestLayer, requestCategory, requestHandler, requestHandlerMethod, result, status, elapsed);
    }

    public static void LogResponse_ThreeParamAdapter_GetData(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed)
    {
        if (!logger.IsEnabled(LogLevel.Information))
            return;

        _logResponse_ThreeParamAdapter_GetData(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, status, elapsed, null);
    }

    public static void LogResponseWarning_ThreeParamAdapter_GetData(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Warning))
            return;

        _logResponseWarning_ThreeParamAdapter_GetData(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, elapsed, error, null);
    }

    public static void LogResponseError_ThreeParamAdapter_GetData(
        this ILogger logger,
        string requestLayer,
        string requestCategory,
        string requestHandler,
        string requestHandlerMethod,
        string status,
        double elapsed,
        global::LanguageExt.Common.Error error)
    {
        if (!logger.IsEnabled(LogLevel.Error))
            return;

        _logResponseError_ThreeParamAdapter_GetData(logger, requestLayer, requestCategory, requestHandler, requestHandlerMethod, elapsed, error, null);
    }
}

